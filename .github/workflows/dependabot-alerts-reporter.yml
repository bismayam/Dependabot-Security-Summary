# This workflow demonstrates how to run the report_dependabot_alerts.sh script
# on a pull request to comment with any open Dependabot alerts.

name: "Dependabot Alert Reporter"

on:
  # Run this workflow whenever a pull request is opened or synchronized
  pull_request:
    types: [opened, synchronize]

jobs:
  report-alerts:
    runs-on: ubuntu-latest
    
    # --- IMPORTANT ---
    # These permissions are required for the GITHUB_TOKEN used by the job.
    # 'dependabot-alerts: read' - to fetch alerts via the GraphQL API.
    # 'pull_requests: write' - to post a comment on the PR.
    permissions:
        contents: read
        security-events: read
        pull-requests: write

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        # This step checks out your code, making the .sh script available.

      - name: "Install jq"
        run: |
          # The ubuntu-latest runner needs jq installed.
          sudo apt-get update
          sudo apt-get install -y jq

      - name: "Make script executable"
        run: chmod +x .github/scripts/report-dependabot-alerts.sh
        # Assumes your script is in the root. Adjust path if needed.

      - name: "Run Dependabot Alert Script"
        env:
          # The GITHUB_TOKEN is automatically provided by GitHub Actions
          # and gets its permissions from the 'permissions' block above.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PAT_TOKEN: ${{ secrets.DEPENDABOT }}
        run: |
          # ${{ github.repository }} provides the "owner/repo" string.
          # ${{ github.event.pull_request.number }} provides the PR number.
          .github/scripts/report-dependabot-alerts.sh "${{ github.repository }}" "${{ github.event.pull_request.number }}"
